import{r as c,j as e,H as oe,R as de,T as ue,D as he}from"./index-BPMqf66b.js";const xe=5*60*1e3,L=30,me=a=>{const n=new Date,i=new Date(a);if(n.getFullYear()===i.getFullYear()&&n.getMonth()===i.getMonth()&&n.getDate()===i.getDate())return i.toLocaleTimeString("zh-CN",{hour:"numeric",minute:"2-digit"});{const h=new Date(n);return h.setDate(n.getDate()-1),h.getFullYear()===i.getFullYear()&&h.getMonth()===i.getMonth()&&h.getDate()===i.getDate()?`昨天 ${i.toLocaleTimeString("zh-CN",{hour:"numeric",minute:"2-digit"})}`:i.toLocaleDateString("zh-CN",{month:"short",day:"numeric",year:"numeric"})}},pe=({description:a})=>e.jsxs("div",{className:"descriptive-image-bubble",children:[e.jsx("div",{className:"descriptive-image-icon",children:e.jsx("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M811.272038 156.318208l-595.873246 0c-46.818305 0-85.124749 38.306444-85.124749 85.124749l0 535.616884c0 46.818305 38.306444 85.124749 85.124749 85.124749l595.873246 0c46.818305 0 85.124749-38.306444 85.124749-85.124749l0-535.616884C896.396787 194.624652 858.090343 156.318208 811.272038 156.318208zM318.595129 255.961626c42.952254 0 77.771271 34.819017 77.771271 77.771271s-34.819017 77.771271-77.771271 77.771271-77.771271-34.819017-77.771271-77.771271S275.642874 255.961626 318.595129 255.961626zM215.398792 734.497467l148.9678-197.609637 106.405425 127.687124 148.968823-191.530175 191.530175 261.45371L215.398792 734.49849z"})})}),e.jsx("p",{children:a})]}),ve=({message:a,stickers:n,character:i})=>{const{payload:u,role:h}=a;switch(u.type){case"text":return e.jsx(e.Fragment,{children:u.content});case"sticker":{const r=n.find(k=>k.id===u.stickerId);return r?e.jsx("img",{src:r.imageUrl,alt:r.name,className:"sticker-in-chat"}):"[表情未找到]"}case"image":return e.jsx(pe,{description:u.description});case"location":return e.jsxs("div",{className:"location-bubble-wechat",children:[e.jsx("div",{className:"location-bubble-text",children:e.jsx("h5",{children:u.name})}),e.jsx("div",{className:"location-bubble-map-preview",children:e.jsx("svg",{viewBox:"0 0 24 24",className:"location-pin-icon",children:e.jsx("path",{d:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"})})})]});case"transfer":{const{status:r,amount:k,notes:x}=u,S=h==="user";let P=`¥${k.toFixed(2)}`,j="",m=null;const D=()=>e.jsxs("svg",{viewBox:"0 0 24 24",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"1.5",fill:"none"}),e.jsx("path",{d:"M7.5 12l3 3 6-6",stroke:"currentColor",strokeWidth:"1.5",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})]}),f=()=>e.jsxs("svg",{viewBox:"0 0 24 24",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"1.5",fill:"none"}),e.jsx("path",{d:"M8 10h6c1.1 0 2 .9 2 2s-.9 2-2 2H8m0 0l2-2m-2 2l2 2",stroke:"currentColor",strokeWidth:"1.5",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})]}),y=()=>e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M20 6H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-8.74 11H4V8h7.26c.33-2.05 2.2-3.67 4.34-3.95v-2.03c-2.39.28-4.47 1.79-5.86 3.98H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h7.26c.33-2.05 2.2-3.67 4.34-3.95v-2.03c-2.39.28-4.47 1.79-5.86 3.98zM18 15c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z",transform:"scale(1.2) translate(-2, -2)"})});if(S)switch(r){case"sent":j=x||`转账给 ${i.name}`,m=e.jsx(y,{});break;case"accepted":j="已被接收",m=e.jsx(D,{});break;case"declined":j="已退还",m=e.jsx(f,{});break}else switch(r){case"received":j=x||"请查收",m=e.jsx(y,{});break;case"accepted":j="已收款",m=e.jsx(D,{});break;case"declined":j="已退还",m=e.jsx(f,{});break}const w=r==="accepted"||r==="declined";return e.jsxs("div",{className:`transfer-bubble ${w?"processed":""}`,children:[e.jsxs("div",{className:"transfer-bubble-main",children:[e.jsx("div",{className:"transfer-icon",children:m}),e.jsxs("div",{className:"transfer-details",children:[e.jsx("span",{className:"transfer-amount",children:P}),e.jsx("span",{className:"transfer-note",children:j})]})]}),e.jsx("div",{className:"transfer-status-bar",children:e.jsx("span",{children:"微信转账"})})]})}default:return null}},je=({stickers:a,onSelectSticker:n,onAddSticker:i,onDeleteSticker:u,isOpen:h})=>{const[r,k]=c.useState(!1);return e.jsxs("div",{className:`sticker-panel ${h?"open":""}`,children:[e.jsx("div",{className:"sticker-panel-header",children:e.jsx("button",{className:"sticker-panel-action-btn",onClick:()=>k(!r),children:r?"完成":"管理"})}),e.jsxs("div",{className:"sticker-grid-chat",children:[a.map(x=>e.jsxs("div",{className:"sticker-item-chat",onClick:()=>!r&&n(x),children:[e.jsx("img",{src:x.imageUrl,alt:x.name}),r&&e.jsx("button",{className:"delete-sticker-btn",onClick:S=>{S.stopPropagation(),u(x.id)},children:"×"})]},x.id)),e.jsx("button",{className:"add-sticker-btn-chat",onClick:i,children:"+"})]})]})},fe=({onAction:a,isOpen:n})=>e.jsx("div",{className:`actions-panel ${n?"open":""}`,children:e.jsxs("div",{className:"actions-grid",children:[e.jsxs("div",{className:"action-item",onClick:()=>a("image"),children:[e.jsx("div",{className:"action-icon-wrapper",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9-2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"})})}),e.jsx("span",{className:"action-label",children:"图片"})]}),e.jsxs("div",{className:"action-item",onClick:()=>a("transfer"),children:[e.jsx("div",{className:"action-icon-wrapper transfer-icon-bg",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M20 6H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 2v2.51c-.63-.33-1.31-.51-2-.51-2.76 0-5 2.24-5 5s2.24 5 5 5c.69 0 1.37-.18 2-.51V20H4V8h16zM18 15c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"})})}),e.jsx("span",{className:"action-label",children:"转账"})]}),e.jsxs("div",{className:"action-item",onClick:()=>a("location"),children:[e.jsx("div",{className:"action-icon-wrapper",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"})})}),e.jsx("span",{className:"action-label",children:"位置"})]})]})}),ke=({character:a,messages:n,onSendMessage:i,onBack:u,onShowDetails:h,userAvatar:r,customStickers:k,onAddSticker:x,onDeleteSticker:S,onDeleteMessage:P,onEditMessage:j,onUpdateTransfer:m,onRespeak:D})=>{const[f,y]=c.useState(""),[w,O]=c.useState(!1),[W,E]=c.useState(null),[te,R]=c.useState(!1),[z,T]=c.useState(null),[p,N]=c.useState(null),[g,G]=c.useState(null),[B,V]=c.useState(""),[b,K]=c.useState([]),[$,U]=c.useState(!0),[X,q]=c.useState(!0),C=c.useRef(null),J=c.useRef(null),Q=c.useRef(null),v=c.useRef(null),I=c.useRef(0);c.useEffect(()=>{const t=n.slice(-L);K(t),U(n.length>L),q(!0)},[n,a.id]),c.useLayoutEffect(()=>{X&&v.current&&(v.current.scrollTop=v.current.scrollHeight,q(!1))},[X,b]);const Z=c.useCallback(()=>{if(!$||!v.current)return;I.current=v.current.scrollHeight;const t=b.length,s=n.slice(Math.max(0,n.length-t-L),n.length-t);K(l=>[...s,...l]),U(n.length-t-L>0)},[b,$,n]);c.useLayoutEffect(()=>{v.current&&I.current>0&&(v.current.scrollTop+=v.current.scrollHeight-I.current,I.current=0)},[b.length]),c.useEffect(()=>{const t=new IntersectionObserver(l=>{l[0].isIntersecting&&Z()},{root:v.current,threshold:.1}),s=Q.current;return s&&t.observe(s),()=>{s&&t.unobserve(s)}},[Z]),c.useEffect(()=>{var l;const t=n[n.length-1],s=b[b.length-1];t&&s&&t.id===s.id&&(t.role==="user"||w)&&((l=C.current)==null||l.scrollIntoView({behavior:"smooth"}))},[n,b,w]);const F=!![...n].reverse().find(t=>t.role==="model"&&t.payload.type==="text"&&t.payload.content.includes("API")),A=n.length>0?n[n.length-1]:null,se=(A==null?void 0:A.role)==="model";c.useEffect(()=>{g&&g.payload.type==="text"?V(g.payload.content):V("")},[g]);const H=t=>{const s=t.trim();return s?s.split("|||").map(d=>d.trim()).filter(Boolean).map(d=>({type:"text",content:d})):[]},ee=async()=>{var l;const t=f.trim();if(t===""||w)return;O(!0),y("");const s=H(t);s.length>0&&await i(a.id,s),O(!1),(l=J.current)==null||l.focus(),setTimeout(()=>{var d;return(d=C.current)==null?void 0:d.scrollIntoView({behavior:"smooth"})},100)},ne=t=>{const s=H(f);y("");const l={type:"sticker",stickerId:t.id};i(a.id,[...s,l]),E(null),setTimeout(()=>{var d;return(d=C.current)==null?void 0:d.scrollIntoView({behavior:"smooth"})},100)},ae=(t,s)=>{const l=H(f);y("");const d=`msg_${Date.now()}_transfer`,_={type:"transfer",amount:t,notes:s,status:"sent"};i(a.id,[...l,_],d),R(!1),setTimeout(()=>{var o;return(o=C.current)==null?void 0:o.scrollIntoView({behavior:"smooth"})},100)},ce=t=>{if(z){const s=H(f);y("");let l=null;z==="image"?l={type:"image",description:t}:z==="location"&&(l={type:"location",name:t}),l&&i(a.id,[...s,l])}T(null),setTimeout(()=>{var s;return(s=C.current)==null?void 0:s.scrollIntoView({behavior:"smooth"})},100)},le=t=>{switch(E(null),t){case"transfer":R(!0);break;case"image":T("image");break;case"location":T("location");break}},ie=(t,s)=>{t.preventDefault(),N({x:t.pageX,y:t.pageY,message:s})};c.useEffect(()=>{const t=()=>N(null);return window.addEventListener("click",t),window.addEventListener("scroll",t,!0),()=>{window.removeEventListener("click",t),window.removeEventListener("scroll",t,!0)}},[]);const Y=()=>{g&&B.trim()&&j(a.id,g.id,B.trim()),G(null)},re=()=>{const t=[...n].reverse().find(s=>s.role==="model");t&&D(a.id,t.id)};return e.jsxs("div",{className:"chat-view","data-character-id":a.id,children:[e.jsx(oe,{title:a.name,onBack:u,onAction:h,actionIcon:"info"}),e.jsxs("main",{ref:v,className:"messages-container",children:[$&&e.jsx("div",{ref:Q,style:{height:"10px",textAlign:"center"}}),b.map((t,s)=>{const l=b[s-1],d=!l||t.timestamp-l.timestamp>xe;if(t.payload.type==="text"&&t.payload.content.trim()==="")return null;const _=t.payload.type!=="text";return e.jsxs(de.Fragment,{children:[d&&e.jsx("div",{className:"timestamp-wrapper",children:e.jsx("span",{className:"timestamp",children:me(t.timestamp)})}),e.jsx("div",{className:`message-bubble-wrapper ${t.role}`,children:e.jsxs("div",{className:`message-bubble ${t.role} ${_?"special-content-bubble":""}`,onContextMenu:o=>ie(o,t),children:[e.jsx("img",{src:t.role==="model"?a.avatarUrl:r,alt:t.role,className:"avatar"}),(g==null?void 0:g.id)===t.id?e.jsxs("div",{className:"message-content editing",children:[e.jsx("textarea",{value:B,onChange:o=>V(o.target.value),onInput:o=>{const M=o.currentTarget;M.style.height="auto",M.style.height=`${M.scrollHeight}px`},onFocus:o=>{const M=o.currentTarget;M.style.height="auto",M.style.height=`${M.scrollHeight}px`},autoFocus:!0,onKeyDown:o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),Y())},onBlur:Y}),e.jsx("button",{onClick:Y,children:"保存"})]}):e.jsx("div",{className:"message-content",children:e.jsx(ve,{message:t,stickers:k,character:a})})]})})]},t.id||s)}),e.jsx("div",{ref:C})]}),e.jsxs("footer",{className:"chat-input-area",children:[e.jsxs("div",{className:"chat-input-controls",children:[se&&e.jsx("button",{className:"respeak-btn",onClick:re,title:"重说",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"})})}),e.jsx("input",{ref:J,type:"text",value:f,onChange:t=>y(t.target.value),onKeyPress:t=>t.key==="Enter"&&!w&&!F&&ee(),placeholder:"输入消息...",disabled:w||F,onFocus:()=>E(null)}),e.jsx("button",{className:"sticker-toggle-btn",onClick:()=>E(t=>t==="stickers"?null:"stickers"),children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"})})}),e.jsx("button",{className:"actions-toggle-btn",onClick:()=>E(t=>t==="actions"?null:"actions"),children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"})})}),f.trim()!==""&&e.jsx("button",{className:"send-btn",onClick:ee,disabled:w||F,children:"发送"})]}),e.jsx(je,{stickers:k,onSelectSticker:ne,onAddSticker:x,onDeleteSticker:S,isOpen:W==="stickers"}),e.jsx(fe,{onAction:le,isOpen:W==="actions"})]}),p&&e.jsxs("div",{className:"context-menu",style:{top:p.y,left:p.x},children:[p.message.payload.type==="text"&&e.jsx("div",{onClick:()=>{G(p.message),N(null)},children:"编辑"}),p.message.payload.type==="transfer"&&p.message.payload.status==="received"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:()=>{m(p.message.id,"accepted"),N(null)},children:"接收"}),e.jsx("div",{onClick:()=>{m(p.message.id,"declined"),N(null)},children:"拒绝"})]}),e.jsx("div",{onClick:()=>{P(a.id,p.message.id),N(null)},children:"删除"})]}),te&&e.jsx(ue,{character:a,onClose:()=>R(!1),onSend:ae}),z&&e.jsx(he,{type:z,onClose:()=>T(null),onSave:ce})]})};export{ke as default};

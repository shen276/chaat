import{r as a,j as e,H as ne,R as ae,T as ie,D as ce}from"./index-m0rfxF2H.js";const le=5*60*1e3,T=30,oe=l=>{const i=new Date,c=new Date(l);if(i.getFullYear()===c.getFullYear()&&i.getMonth()===c.getMonth()&&i.getDate()===c.getDate())return c.toLocaleTimeString("zh-CN",{hour:"numeric",minute:"2-digit"});{const o=new Date(i);return o.setDate(i.getDate()-1),o.getFullYear()===c.getFullYear()&&o.getMonth()===c.getMonth()&&o.getDate()===c.getDate()?`昨天 ${c.toLocaleTimeString("zh-CN",{hour:"numeric",minute:"2-digit"})}`:c.toLocaleDateString("zh-CN",{month:"short",day:"numeric",year:"numeric"})}},re=({description:l})=>e.jsxs("div",{className:"descriptive-image-bubble",children:[e.jsx("div",{className:"descriptive-image-icon",children:e.jsx("svg",{viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M811.272038 156.318208l-595.873246 0c-46.818305 0-85.124749 38.306444-85.124749 85.124749l0 535.616884c0 46.818305 38.306444 85.124749 85.124749 85.124749l595.873246 0c46.818305 0 85.124749-38.306444 85.124749-85.124749l0-535.616884C896.396787 194.624652 858.090343 156.318208 811.272038 156.318208zM318.595129 255.961626c42.952254 0 77.771271 34.819017 77.771271 77.771271s-34.819017 77.771271-77.771271 77.771271-77.771271-34.819017-77.771271-77.771271S275.642874 255.961626 318.595129 255.961626zM215.398792 734.497467l148.9678-197.609637 106.405425 127.687124 148.968823-191.530175 191.530175 261.45371L215.398792 734.49849z"})})}),e.jsx("p",{children:l})]}),de=({message:l,stickers:i})=>{const{payload:c,role:g}=l;switch(c.type){case"text":return e.jsx(e.Fragment,{children:c.content});case"sticker":{const o=i.find(r=>r.id===c.stickerId);return o?e.jsx("img",{src:o.imageUrl,alt:o.name,className:"sticker-in-chat"}):"[表情未找到]"}case"image":return e.jsx(re,{description:c.description});case"location":return e.jsxs("div",{className:"location-bubble-wechat",children:[e.jsx("div",{className:"location-bubble-text",children:e.jsx("h5",{children:c.name})}),e.jsx("div",{className:"location-bubble-map-preview",children:e.jsx("svg",{viewBox:"0 0 24 24",className:"location-pin-icon",children:e.jsx("path",{d:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"})})})]});case"transfer":{const o=g==="user",r=c.notes||(o?"转账给朋友":"收到转账");return e.jsxs("div",{className:`transfer-bubble ${o?"sent":"received"}`,children:[e.jsx("div",{className:"transfer-icon",children:e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M12 2L2 7l10 5 10-5-10-5z"}),e.jsx("path",{d:"M2 17l10 5 10-5"}),e.jsx("path",{d:"M2 12l10 5 10-5"})]})}),e.jsxs("div",{className:"transfer-details",children:[e.jsxs("span",{className:"transfer-amount",children:["¥",c.amount.toFixed(2)]}),e.jsx("span",{className:"transfer-note",children:r})]})]})}default:return null}},ue=({stickers:l,onSelectSticker:i,onAddSticker:c,onDeleteSticker:g,isOpen:o})=>{const[r,S]=a.useState(!1);return e.jsxs("div",{className:`sticker-panel ${o?"open":""}`,children:[e.jsx("div",{className:"sticker-panel-header",children:e.jsx("button",{className:"sticker-panel-action-btn",onClick:()=>S(!r),children:r?"完成":"管理"})}),e.jsxs("div",{className:"sticker-grid-chat",children:[l.map(p=>e.jsxs("div",{className:"sticker-item-chat",onClick:()=>!r&&i(p),children:[e.jsx("img",{src:p.imageUrl,alt:p.name}),r&&e.jsx("button",{className:"delete-sticker-btn",onClick:z=>{z.stopPropagation(),g(p.id)},children:"×"})]},p.id)),e.jsx("button",{className:"add-sticker-btn-chat",onClick:c,children:"+"})]})]})},he=({onAction:l,isOpen:i})=>e.jsx("div",{className:`actions-panel ${i?"open":""}`,children:e.jsxs("div",{className:"actions-grid",children:[e.jsxs("div",{className:"action-item",onClick:()=>l("image"),children:[e.jsx("div",{className:"action-icon-wrapper",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9-2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"})})}),e.jsx("span",{className:"action-label",children:"图片"})]}),e.jsxs("div",{className:"action-item",onClick:()=>l("transfer"),children:[e.jsx("div",{className:"action-icon-wrapper transfer-icon-bg",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M20 6H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 2v2.51c-.63-.33-1.31-.51-2-.51-2.76 0-5 2.24-5 5s2.24 5 5 5c.69 0 1.37-.18 2-.51V20H4V8h16zM18 15c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"})})}),e.jsx("span",{className:"action-label",children:"转账"})]}),e.jsxs("div",{className:"action-item",onClick:()=>l("location"),children:[e.jsx("div",{className:"action-icon-wrapper",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"})})}),e.jsx("span",{className:"action-label",children:"位置"})]})]})}),pe=({character:l,messages:i,onSendMessage:c,onBack:g,onShowDetails:o,userAvatar:r,customStickers:S,onAddSticker:p,onDeleteSticker:z,onDeleteMessage:X,onEditMessage:q})=>{const[v,w]=a.useState(""),[j,F]=a.useState(!1),[P,N]=a.useState(null),[J,I]=a.useState(!1),[M,k]=a.useState(null),[b,C]=a.useState(null),[h,$]=a.useState(null),[L,H]=a.useState(""),[x,A]=a.useState([]),[R,Y]=a.useState(!0),[O,_]=a.useState(!0),y=a.useRef(null),G=a.useRef(null),K=a.useRef(null),u=a.useRef(null),E=a.useRef(0);a.useEffect(()=>{const t=i.slice(-T);A(t),Y(i.length>T),_(!0)},[i,l.id]),a.useLayoutEffect(()=>{O&&u.current&&(u.current.scrollTop=u.current.scrollHeight,_(!1))},[O,x]);const U=a.useCallback(()=>{if(!R||!u.current)return;E.current=u.current.scrollHeight;const t=x.length,s=i.slice(Math.max(0,i.length-t-T),i.length-t);A(n=>[...s,...n]),Y(i.length-t-T>0)},[x,R,i]);a.useLayoutEffect(()=>{u.current&&E.current>0&&(u.current.scrollTop+=u.current.scrollHeight-E.current,E.current=0)},[x.length]),a.useEffect(()=>{const t=new IntersectionObserver(n=>{n[0].isIntersecting&&U()},{root:u.current,threshold:.1}),s=K.current;return s&&t.observe(s),()=>{s&&t.unobserve(s)}},[U]),a.useEffect(()=>{var n;const t=i[i.length-1],s=x[x.length-1];t&&s&&t.id===s.id&&(t.role==="user"||j)&&((n=y.current)==null||n.scrollIntoView({behavior:"smooth"}))},[i,x,j]);const V=!![...i].reverse().find(t=>t.role==="model"&&t.payload.type==="text"&&t.payload.content.includes("API"));a.useEffect(()=>{h&&h.payload.type==="text"?H(h.payload.content):H("")},[h]);const W=async()=>{var s;const t=v.trim();t===""||j||(F(!0),w(""),await c(l.id,{type:"text",content:t}),F(!1),(s=G.current)==null||s.focus(),setTimeout(()=>{var n;return(n=y.current)==null?void 0:n.scrollIntoView({behavior:"smooth"})},100))},Q=t=>{const s=v.trim(),n=[];s&&(n.push({type:"text",content:s}),w("")),n.push({type:"sticker",stickerId:t.id}),c(l.id,n),N(null),setTimeout(()=>{var m;return(m=y.current)==null?void 0:m.scrollIntoView({behavior:"smooth"})},100)},Z=(t,s)=>{const n=v.trim(),m=[];n&&(m.push({type:"text",content:n}),w("")),m.push({type:"transfer",amount:t,notes:s}),c(l.id,m),I(!1),setTimeout(()=>{var D;return(D=y.current)==null?void 0:D.scrollIntoView({behavior:"smooth"})},100)},ee=t=>{if(M){const s=v.trim(),n=[];s&&(n.push({type:"text",content:s}),w("")),M==="image"?n.push({type:"image",description:t}):M==="location"&&n.push({type:"location",name:t}),n.length>0&&c(l.id,n)}k(null),setTimeout(()=>{var s;return(s=y.current)==null?void 0:s.scrollIntoView({behavior:"smooth"})},100)},te=t=>{switch(N(null),t){case"transfer":I(!0);break;case"image":k("image");break;case"location":k("location");break}},se=(t,s)=>{t.preventDefault(),C({x:t.pageX,y:t.pageY,message:s})};a.useEffect(()=>{const t=()=>C(null);return window.addEventListener("click",t),window.addEventListener("scroll",t,!0),()=>{window.removeEventListener("click",t),window.removeEventListener("scroll",t,!0)}},[]);const B=()=>{h&&L.trim()&&q(l.id,h.id,L.trim()),$(null)};return e.jsxs("div",{className:"chat-view","data-character-id":l.id,children:[e.jsx(ne,{title:l.name,onBack:g,onAction:o,actionIcon:"info"}),e.jsxs("main",{ref:u,className:"messages-container",children:[R&&e.jsx("div",{ref:K,style:{height:"10px",textAlign:"center"}}),x.map((t,s)=>{const n=x[s-1],m=!n||t.timestamp-n.timestamp>le;if(t.payload.type==="text"&&t.payload.content.trim()==="")return null;const D=t.payload.type!=="text";return e.jsxs(ae.Fragment,{children:[m&&e.jsx("div",{className:"timestamp-wrapper",children:e.jsx("span",{className:"timestamp",children:oe(t.timestamp)})}),e.jsx("div",{className:`message-bubble-wrapper ${t.role}`,children:e.jsxs("div",{className:`message-bubble ${t.role} ${D?"special-content-bubble":""}`,onContextMenu:d=>se(d,t),children:[e.jsx("img",{src:t.role==="model"?l.avatarUrl:r,alt:t.role,className:"avatar"}),(h==null?void 0:h.id)===t.id?e.jsxs("div",{className:"message-content editing",children:[e.jsx("textarea",{value:L,onChange:d=>H(d.target.value),onInput:d=>{const f=d.currentTarget;f.style.height="auto",f.style.height=`${f.scrollHeight}px`},onFocus:d=>{const f=d.currentTarget;f.style.height="auto",f.style.height=`${f.scrollHeight}px`},autoFocus:!0,onKeyDown:d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),B())},onBlur:B}),e.jsx("button",{onClick:B,children:"保存"})]}):e.jsx("div",{className:"message-content",children:e.jsx(de,{message:t,stickers:S})})]})})]},t.id||s)}),e.jsx("div",{ref:y})]}),e.jsxs("footer",{className:"chat-input-area",children:[e.jsxs("div",{className:"chat-input-controls",children:[e.jsx("input",{ref:G,type:"text",value:v,onChange:t=>w(t.target.value),onKeyPress:t=>t.key==="Enter"&&!j&&!V&&W(),placeholder:"输入消息...",disabled:j||V,onFocus:()=>N(null)}),e.jsx("button",{className:"sticker-toggle-btn",onClick:()=>N(t=>t==="stickers"?null:"stickers"),children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"})})}),v.trim()!==""?e.jsx("button",{className:"send-btn",onClick:W,disabled:j||V||v.trim()==="",children:"发送"}):e.jsx("button",{className:"actions-toggle-btn",onClick:()=>N(t=>t==="actions"?null:"actions"),children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"})})})]}),e.jsx(ue,{stickers:S,onSelectSticker:Q,onAddSticker:p,onDeleteSticker:z,isOpen:P==="stickers"}),e.jsx(he,{onAction:te,isOpen:P==="actions"})]}),b&&e.jsxs("div",{className:"context-menu",style:{top:b.y,left:b.x},children:[b.message.payload.type==="text"&&e.jsx("div",{onClick:()=>{$(b.message),C(null)},children:"编辑"}),e.jsx("div",{onClick:()=>{X(l.id,b.message.id),C(null)},children:"删除"})]}),J&&e.jsx(ie,{character:l,onClose:()=>I(!1),onSend:Z}),M&&e.jsx(ce,{type:M,onClose:()=>k(null),onSave:ee})]})};export{pe as default};
